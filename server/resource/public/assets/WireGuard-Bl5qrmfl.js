import{w as f}from"./index-B4JhxhO9.js";import{r as c,k as Ie,o as Fe,l as Ue,a as x,c as ae,d as l,w as t,e as d,m as De,b as n,p as $e,t as _,h as S,j as v,q as Ae,s as oe,v as G,x as ne,y as Se,z as Ne,E as m,A as Re}from"./index-JfatmDp6.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ke={class:"wireguard-page"},Te={class:"status-header"},Ee={class:"status-info"},Ge={class:"status-text"},Le={class:"status-actions"},We={class:"status-details"},he={class:"detail-item"},ze={class:"value"},qe={class:"detail-item"},Me={class:"value"},je={class:"detail-item"},Qe={class:"value key"},Oe={class:"detail-item"},He={class:"value"},Je={class:"card-header"},Xe={class:"header-actions"},Ye={class:"traffic"},Ze={class:"key-display"},el={class:"key-text"},ll={class:"key-display"},tl={class:"key-text"},al={class:"qrcode-container"},ol=["src"],nl={__name:"WireGuard",setup(sl){const r=c(!1),R=c(!1),B=c(!1),b=c({}),Q=c([]),F=c(!1),N=c(!1),L=c(!1),k=c(null),W=c(""),K=c(parseInt(localStorage.getItem("wg_refresh_interval")||"5"));let T=null;const w=c({name:"",allowedIPs:""}),s=c({listenPort:51820,address:"",dns:"223.5.5.5",mtu:1420,endpointAddress:"",ethDevice:"",persistentKeepalive:25,clientAllowedIPs:"",proxyAddress:"",logLevel:"error",autoStart:!1});Ie(()=>s.value.address,a=>{if(!a)return;if(a.match(/^(\d+\.\d+\.\d+\.\d+\/\d+)$/)){const g=a.split("/"),i=parseInt(g[1]),u=g[0].split(".").map(Number),I=i>=32?4294967295:4294967295<<32-i>>>0,D=((u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0&I)>>>0,z=[D>>>24&255,D>>>16&255,D>>>8&255,D&255].join(".");s.value.clientAllowedIPs=z+"/"+i}});const O=()=>{H(),K.value>0&&(T=setInterval(()=>{R.value||(E(),U())},K.value*1e3))},H=()=>{T&&(clearInterval(T),T=null)},se=a=>{localStorage.setItem("wg_refresh_interval",a.toString()),O()},U=async()=>{try{const a=await f.status();b.value=a.data||{}}catch(a){console.error(a)}},E=async()=>{R.value=!0;try{const a=await f.peers();Q.value=a.data?.peers||[]}catch(a){console.error(a)}R.value=!1},h=async()=>{try{const a=await f.config();a.data&&(s.value=a.data)}catch(a){console.error(a)}},de=async()=>{r.value=!0;try{await f.start(),m.success("服务已启动"),await U(),await h()}catch(a){console.error(a)}r.value=!1},ue=async()=>{r.value=!0;try{await f.stop(),m.success("服务已停止"),await U()}catch(a){console.error(a)}r.value=!1},ie=async()=>{r.value=!0;try{await f.restart(),m.success("服务已重启"),await U()}catch(a){console.error(a)}r.value=!1},re=async()=>{if(!w.value.name){m.warning("请输入客户端名称");return}r.value=!0;try{k.value?await f.updatePeer(k.value.id,w.value):await f.createPeer(w.value),m.success(k.value?"保存成功":"添加成功"),F.value=!1,w.value={name:"",allowedIPs:""},k.value=null,await E()}catch(a){console.error(a)}r.value=!1},pe=a=>{k.value=a,w.value={name:a.name,allowedIPs:a.allowedIPs},F.value=!0},ve=async a=>{try{await Re.confirm(`确定删除客户端 "${a.name}" 吗？`,"确认删除",{type:"warning"}),await f.deletePeer(a.id),m.success("删除成功"),await E()}catch{}},me=async a=>{try{await f.updatePeer(a.id,{enabled:a.enabled}),m.success(a.enabled?"已启用":"已禁用")}catch{a.enabled=!a.enabled}},fe=async a=>{try{const e=await f.peerQRCode(a.id);W.value=e.data?.qrcode||"",L.value=!0}catch(e){console.error(e)}},ce=async a=>{try{const e=await f.peerConfig(a.id),g=e.data?.config||e.config||"";if(!g){m.error(e.message||"获取配置失败，请检查是否已配置公网地址");return}const i=new Blob([g],{type:"text/plain"}),u=URL.createObjectURL(i),I=document.createElement("a");I.href=u,I.download=`${a.name}.conf`,I.click(),URL.revokeObjectURL(u)}catch(e){console.error(e),m.error("下载配置失败，请检查是否已配置公网地址")}},_e=async()=>{if(!s.value.endpointAddress?.trim()){m.warning("请填写公网地址，客户端需要此地址连接服务器");return}r.value=!0;try{await f.updateConfig(s.value),m.success("配置已保存"),N.value=!1,await U(),await h()}catch(a){console.error(a)}r.value=!1},ge=a=>a?`${a.slice(0,10)}...${a.slice(-6)}`:"未配置",J=async(a,e)=>{if(!a){m.warning(`${e}为空`);return}try{await navigator.clipboard.writeText(a),m.success(`${e}已复制`)}catch{m.error("复制失败")}},X=a=>{if(!a)return"0 B";const e=["B","KB","MB","GB","TB"];let g=0;for(;a>=1024&&g<e.length-1;)a/=1024,g++;return`${a.toFixed(1)} ${e[g]}`};return Fe(()=>{U(),E(),h(),O()}),Ue(()=>{H()}),(a,e)=>{const g=d("VideoPlay"),i=d("el-icon"),u=d("el-button"),I=d("VideoPause"),Y=d("Refresh"),D=d("Setting"),z=d("el-tooltip"),Z=d("el-card"),V=d("el-option"),ee=d("el-select"),ye=d("Plus"),P=d("el-table-column"),we=d("el-tag"),le=d("el-switch"),be=d("Cellphone"),Ve=d("Download"),ke=d("Edit"),Pe=d("Delete"),Ce=d("el-table"),C=d("el-input"),p=d("el-form-item"),te=d("el-form"),q=d("el-dialog"),M=d("el-divider"),y=d("el-col"),$=d("el-row"),j=d("el-input-number"),xe=De("loading");return x(),ae("div",Ke,[l(Z,{class:"status-card"},{default:t(()=>[n("div",Te,[n("div",Ee,[n("div",{class:$e(["status-indicator",{online:b.value.running}])},null,2),n("span",Ge,_(b.value.running?"服务运行中":"服务已停止"),1)]),n("div",Le,[b.value.running?(x(),S(u,{key:1,type:"danger",onClick:ue,loading:r.value},{default:t(()=>[l(i,null,{default:t(()=>[l(I)]),_:1}),e[25]||(e[25]=v(" 停止 ",-1))]),_:1},8,["loading"])):(x(),S(u,{key:0,type:"success",onClick:de,loading:r.value},{default:t(()=>[l(i,null,{default:t(()=>[l(g)]),_:1}),e[24]||(e[24]=v(" 启动 ",-1))]),_:1},8,["loading"])),l(u,{onClick:ie,loading:r.value},{default:t(()=>[l(i,null,{default:t(()=>[l(Y)]),_:1}),e[26]||(e[26]=v(" 重启 ",-1))]),_:1},8,["loading"]),l(u,{onClick:e[0]||(e[0]=o=>N.value=!0)},{default:t(()=>[l(i,null,{default:t(()=>[l(D)]),_:1}),e[27]||(e[27]=v(" 配置 ",-1))]),_:1})])]),n("div",We,[n("div",he,[e[28]||(e[28]=n("span",{class:"label"},"接口",-1)),n("span",ze,_(b.value.interface||"omniwire"),1)]),n("div",qe,[e[29]||(e[29]=n("span",{class:"label"},"监听端口",-1)),n("span",Me,_(b.value.listenPort||51820),1)]),n("div",je,[e[30]||(e[30]=n("span",{class:"label"},"公钥",-1)),l(z,{content:b.value.publicKey,placement:"top"},{default:t(()=>[n("span",Qe,_(ge(b.value.publicKey)),1)]),_:1},8,["content"])]),n("div",Oe,[e[31]||(e[31]=n("span",{class:"label"},"客户端数量",-1)),n("span",He,_(b.value.peerCount||0),1)])])]),_:1}),l(Z,null,{header:t(()=>[n("div",Je,[e[33]||(e[33]=n("span",null,"客户端管理",-1)),n("div",Xe,[l(ee,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=o=>K.value=o),onChange:se,size:"small",style:{width:"100px"}},{default:t(()=>[l(V,{value:0,label:"不刷新"}),l(V,{value:3,label:"3秒"}),l(V,{value:5,label:"5秒"}),l(V,{value:10,label:"10秒"}),l(V,{value:30,label:"30秒"})]),_:1},8,["modelValue"]),l(u,{type:"primary",onClick:e[2]||(e[2]=o=>F.value=!0)},{default:t(()=>[l(i,null,{default:t(()=>[l(ye)]),_:1}),e[32]||(e[32]=v(" 添加客户端 ",-1))]),_:1})])])]),default:t(()=>[Ae((x(),S(Ce,{data:Q.value,style:{width:"100%"}},{default:t(()=>[l(P,{prop:"id",label:"ID",width:"60"}),l(P,{prop:"name",label:"名称","min-width":"120"}),l(P,{label:"状态",width:"100"},{default:t(({row:o})=>[l(we,{type:o.online?"success":"info",size:"small"},{default:t(()=>[v(_(o.online?"在线":"离线"),1)]),_:2},1032,["type"])]),_:1}),l(P,{label:"IP 地址","min-width":"140"},{default:t(({row:o})=>[n("code",null,_(o.allowedIPs),1)]),_:1}),l(P,{label:"最后握手","min-width":"120"},{default:t(({row:o})=>[v(_(o.latestHandshake||"从未连接"),1)]),_:1}),l(P,{label:"流量","min-width":"150"},{default:t(({row:o})=>[n("span",Ye," ↓ "+_(X(o.transferRx))+" / ↑ "+_(X(o.transferTx)),1)]),_:1}),l(P,{label:"启用",width:"80"},{default:t(({row:o})=>[l(le,{modelValue:o.enabled,"onUpdate:modelValue":A=>o.enabled=A,onChange:A=>me(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(P,{label:"操作",width:"200",fixed:"right"},{default:t(({row:o})=>[l(u,{link:"",type:"primary",onClick:A=>fe(o)},{default:t(()=>[l(i,null,{default:t(()=>[l(be)]),_:1})]),_:1},8,["onClick"]),l(u,{link:"",type:"primary",onClick:A=>ce(o)},{default:t(()=>[l(i,null,{default:t(()=>[l(Ve)]),_:1})]),_:1},8,["onClick"]),l(u,{link:"",type:"primary",onClick:A=>pe(o)},{default:t(()=>[l(i,null,{default:t(()=>[l(ke)]),_:1})]),_:1},8,["onClick"]),l(u,{link:"",type:"danger",onClick:A=>ve(o)},{default:t(()=>[l(i,null,{default:t(()=>[l(Pe)]),_:1})]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[xe,R.value]])]),_:1}),l(q,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=o=>F.value=o),title:k.value?"编辑客户端":"添加客户端",width:"500px"},{footer:t(()=>[l(u,{onClick:e[5]||(e[5]=o=>F.value=!1)},{default:t(()=>[...e[35]||(e[35]=[v("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:re,loading:r.value},{default:t(()=>[v(_(k.value?"保存":"添加"),1)]),_:1},8,["loading"])]),default:t(()=>[l(te,{model:w.value,"label-width":"100px"},{default:t(()=>[l(p,{label:"名称",required:""},{default:t(()=>[l(C,{modelValue:w.value.name,"onUpdate:modelValue":e[3]||(e[3]=o=>w.value.name=o),placeholder:"请输入客户端名称"},null,8,["modelValue"])]),_:1}),k.value?oe("",!0):(x(),S(p,{key:0,label:"IP 地址"},{default:t(()=>[l(C,{modelValue:w.value.allowedIPs,"onUpdate:modelValue":e[4]||(e[4]=o=>w.value.allowedIPs=o),placeholder:"留空自动分配"},null,8,["modelValue"]),e[34]||(e[34]=n("div",{class:"form-tip"},"留空将自动从地址池分配 IP",-1))]),_:1}))]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(q,{modelValue:N.value,"onUpdate:modelValue":e[22]||(e[22]=o=>N.value=o),title:"WireGuard 配置",width:"900px"},{footer:t(()=>[l(u,{onClick:e[21]||(e[21]=o=>N.value=!1)},{default:t(()=>[...e[51]||(e[51]=[v("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:_e,loading:r.value},{default:t(()=>[...e[52]||(e[52]=[v("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(te,{model:s.value,"label-width":"100px",size:"default"},{default:t(()=>[l(M,{"content-position":"left"},{default:t(()=>[...e[36]||(e[36]=[v("密钥信息",-1)])]),_:1}),e[50]||(e[50]=n("div",{class:"section-tip"},"密钥由系统自动生成，无需手动管理。公钥用于客户端配置，私钥请妥善保管。",-1)),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"公钥"},{default:t(()=>[n("div",Ze,[n("code",el,_(s.value.publicKey||"未生成"),1),l(u,{link:"",onClick:e[7]||(e[7]=o=>J(s.value.publicKey,"公钥"))},{default:t(()=>[l(i,null,{default:t(()=>[l(G(ne))]),_:1})]),_:1})])]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"私钥"},{default:t(()=>[n("div",ll,[n("code",tl,_(B.value?s.value.privateKey||"未生成":"••••••••••••••••••••"),1),l(u,{link:"",onClick:e[8]||(e[8]=o=>B.value=!B.value)},{default:t(()=>[l(i,null,{default:t(()=>[B.value?(x(),S(G(Ne),{key:1})):(x(),S(G(Se),{key:0}))]),_:1})]),_:1}),l(u,{link:"",onClick:e[9]||(e[9]=o=>J(s.value.privateKey,"私钥"))},{default:t(()=>[l(i,null,{default:t(()=>[l(G(ne))]),_:1})]),_:1})])]),_:1})]),_:1})]),_:1}),l(M,{"content-position":"left"},{default:t(()=>[...e[37]||(e[37]=[v("服务配置",-1)])]),_:1}),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"公网地址"},{default:t(()=>[l(C,{modelValue:s.value.endpointAddress,"onUpdate:modelValue":e[10]||(e[10]=o=>s.value.endpointAddress=o),placeholder:"IP 或域名"},null,8,["modelValue"]),e[38]||(e[38]=n("div",{class:"form-tip"},"服务器公网 IP 或域名，客户端通过此地址连接",-1))]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"VPN 网段"},{default:t(()=>[l(C,{modelValue:s.value.address,"onUpdate:modelValue":e[11]||(e[11]=o=>s.value.address=o),placeholder:"10.66.66.0/24"},null,8,["modelValue"]),e[39]||(e[39]=n("div",{class:"form-tip"},"VPN 内网地址段，客户端将从此网段分配 IP",-1))]),_:1})]),_:1})]),_:1}),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"监听端口"},{default:t(()=>[l(j,{modelValue:s.value.listenPort,"onUpdate:modelValue":e[12]||(e[12]=o=>s.value.listenPort=o),min:1,max:65535,style:{width:"100%"}},null,8,["modelValue"]),e[40]||(e[40]=n("div",{class:"form-tip"},"WireGuard UDP 监听端口",-1))]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"MTU"},{default:t(()=>[l(j,{modelValue:s.value.mtu,"onUpdate:modelValue":e[13]||(e[13]=o=>s.value.mtu=o),min:1280,max:1500,style:{width:"100%"}},null,8,["modelValue"]),e[41]||(e[41]=n("div",{class:"form-tip"},"最大传输单元，建议保持默认",-1))]),_:1})]),_:1})]),_:1}),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"DNS"},{default:t(()=>[l(C,{modelValue:s.value.dns,"onUpdate:modelValue":e[14]||(e[14]=o=>s.value.dns=o),placeholder:"223.5.5.5"},null,8,["modelValue"]),e[42]||(e[42]=n("div",{class:"form-tip"},"客户端使用的 DNS 服务器地址",-1))]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"客户端路由"},{default:t(()=>[l(C,{modelValue:s.value.clientAllowedIPs,"onUpdate:modelValue":e[15]||(e[15]=o=>s.value.clientAllowedIPs=o),placeholder:"根据 VPN 网段自动生成"},null,8,["modelValue"]),e[43]||(e[43]=n("div",{class:"form-tip"},"客户端流量转发范围，随 VPN 网段自动同步",-1))]),_:1})]),_:1})]),_:1}),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"网卡接口"},{default:t(()=>[l(C,{modelValue:s.value.ethDevice,"onUpdate:modelValue":e[16]||(e[16]=o=>s.value.ethDevice=o),placeholder:"如 eth0（可选）"},null,8,["modelValue"]),e[44]||(e[44]=n("div",{class:"form-tip"},"服务器出口网卡名称，用于 NAT 转发",-1))]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"存活间隔"},{default:t(()=>[l(j,{modelValue:s.value.persistentKeepalive,"onUpdate:modelValue":e[17]||(e[17]=o=>s.value.persistentKeepalive=o),min:0,max:3600,style:{width:"100%"}},null,8,["modelValue"]),e[45]||(e[45]=n("div",{class:"form-tip"},"NAT 保活心跳间隔（秒），建议 25",-1))]),_:1})]),_:1})]),_:1}),l($,{gutter:20},{default:t(()=>[l(y,{span:12},{default:t(()=>[l(p,{label:"TCP 中转"},{default:t(()=>[l(C,{modelValue:s.value.proxyAddress,"onUpdate:modelValue":e[18]||(e[18]=o=>s.value.proxyAddress=o),placeholder:":50122 (可选)"},null,8,["modelValue"]),e[46]||(e[46]=n("div",{class:"form-tip"},"UDP 被限速时可启用 TCP 中转，留空不开启",-1))]),_:1})]),_:1}),l(y,{span:12},{default:t(()=>[l(p,{label:"日志等级"},{default:t(()=>[l(ee,{modelValue:s.value.logLevel,"onUpdate:modelValue":e[19]||(e[19]=o=>s.value.logLevel=o),style:{width:"100%"}},{default:t(()=>[l(V,{label:"错误 (Error)",value:"error"}),l(V,{label:"警告 (Warning)",value:"warning"}),l(V,{label:"信息 (Info)",value:"info"}),l(V,{label:"调试 (Debug)",value:"debug"})]),_:1},8,["modelValue"]),e[47]||(e[47]=n("div",{class:"form-tip"},"WireGuard 日志输出级别",-1))]),_:1})]),_:1})]),_:1}),l(M,{"content-position":"left"},{default:t(()=>[...e[48]||(e[48]=[v("启动选项",-1)])]),_:1}),l(p,{label:"开机自启"},{default:t(()=>[l(le,{modelValue:s.value.autoStart,"onUpdate:modelValue":e[20]||(e[20]=o=>s.value.autoStart=o)},null,8,["modelValue"]),e[49]||(e[49]=n("span",{style:{"margin-left":"8px","font-size":"12px",color:"#909399"}},"服务启动时自动启动 WireGuard",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(q,{modelValue:L.value,"onUpdate:modelValue":e[23]||(e[23]=o=>L.value=o),title:"扫描二维码",width:"350px",center:""},{default:t(()=>[n("div",al,[W.value?(x(),ae("img",{key:0,src:W.value,alt:"QR Code"},null,8,ol)):oe("",!0),e[53]||(e[53]=n("p",null,"使用 WireGuard 客户端扫描此二维码",-1))])]),_:1},8,["modelValue"])])}}},rl=Be(nl,[["__scopeId","data-v-335b50a3"]]);export{rl as default};
