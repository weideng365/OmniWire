import{w as _}from"./index-Cz2QBiLu.js";import{r as g,z as we,o as be,A as Ve,a as x,c as L,d as e,w as t,e as r,B as he,b as o,x as ee,C as le,t as v,n as B,h as i,D as ke,y as w,E as xe,F as Ce,k as Pe,G as te,H as ae,I as Fe,J as Ie,K as Ue,L as $e,M as se,N as Ae,i as De,O as oe,P as Be,Q as Se,R as f,S as Re}from"./index-BSRU_Tbs.js";import{_ as Ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ne={class:"wireguard-page"},ze={class:"status-header"},Ge={class:"status-info"},Le={key:0,class:"status-pulse"},Te={class:"status-text-group"},We={class:"status-title"},qe={class:"status-subtitle"},Ee={class:"status-actions"},Me={class:"status-details"},Qe={class:"detail-item"},je={class:"value"},Oe={class:"detail-item"},He={class:"value highlight"},Je={class:"detail-item"},Xe={class:"value key"},Ye={class:"detail-item"},Ze={class:"value highlight"},el={class:"card-header"},ll={class:"header-title"},tl={class:"header-actions"},al={class:"refresh-control"},sl={class:"peer-name"},ol={class:"ip-tag"},nl={class:"time-text"},dl={class:"traffic-stats"},ul={class:"rx"},il={class:"tx"},rl={class:"config-section"},cl={class:"key-display"},pl={class:"key-text"},vl={class:"key-display"},fl={class:"key-text"},ml={class:"config-section"},_l={class:"config-section"},gl={class:"qrcode-container"},yl={class:"qr-wrapper"},wl=["src"],bl={key:1,class:"qr-placeholder"},Vl={__name:"WireGuard",setup(hl){const c=g(!1),R=g(!1),K=g(!1),b=g({}),Q=g([]),U=g(!1),S=g(!1),T=g(!1),C=g(null),W=g(""),N=g(parseInt(localStorage.getItem("wg_refresh_interval")||"5"));let z=null;const V=g({name:"",allowedIPs:""}),n=g({listenPort:51820,address:"",dns:"223.5.5.5",mtu:1420,endpointAddress:"",ethDevice:"",persistentKeepalive:25,clientAllowedIPs:"",proxyAddress:"",logLevel:"error",autoStart:!1});we(()=>n.value.address,s=>{if(!s)return;if(s.match(/^(\d+\.\d+\.\d+\.\d+\/\d+)$/)){const d=s.split("/"),u=parseInt(d[1]),m=d[0].split(".").map(Number),P=u>=32?4294967295:4294967295<<32-u>>>0,I=((m[0]<<24|m[1]<<16|m[2]<<8|m[3])>>>0&P)>>>0,k=[I>>>24&255,I>>>16&255,I>>>8&255,I&255].join(".");n.value.clientAllowedIPs=k+"/"+u}});const j=()=>{O(),N.value>0&&(z=setInterval(()=>{R.value||(G(),$())},N.value*1e3))},O=()=>{z&&(clearInterval(z),z=null)},ne=s=>{localStorage.setItem("wg_refresh_interval",s.toString()),j()},$=async()=>{try{const s=await _.status();b.value=s.data||{}}catch(s){console.error(s)}},G=async()=>{R.value=!0;try{const s=await _.peers();Q.value=s.data?.peers||[]}catch(s){console.error(s)}R.value=!1},q=async()=>{try{const s=await _.config();s.data&&(n.value=s.data)}catch(s){console.error(s)}},de=async()=>{c.value=!0;try{await _.start(),f.success("服务已启动"),await $(),await q()}catch(s){console.error(s)}c.value=!1},ue=async()=>{c.value=!0;try{await _.stop(),f.success("服务已停止"),await $()}catch(s){console.error(s)}c.value=!1},ie=async()=>{c.value=!0;try{await _.restart(),f.success("服务已重启"),await $()}catch(s){console.error(s)}c.value=!1},re=async()=>{if(!V.value.name){f.warning("请输入客户端名称");return}c.value=!0;try{C.value?await _.updatePeer(C.value.id,V.value):await _.createPeer(V.value),f.success(C.value?"保存成功":"添加成功"),U.value=!1,V.value={name:"",allowedIPs:""},C.value=null,await G()}catch(s){console.error(s)}c.value=!1},ce=s=>{C.value=s,V.value={name:s.name,allowedIPs:s.allowedIPs},U.value=!0},pe=async s=>{try{await Re.confirm(`确定删除客户端 "${s.name}" 吗？`,"确认删除",{type:"warning"}),await _.deletePeer(s.id),f.success("删除成功"),await G()}catch{}},ve=async s=>{try{await _.updatePeer(s.id,{enabled:s.enabled}),f.success(s.enabled?"已启用":"已禁用")}catch{s.enabled=!s.enabled}},fe=async s=>{try{const l=await _.peerQRCode(s.id);W.value=l.data?.qrcode||"",T.value=!0}catch(l){console.error(l)}},me=async s=>{try{const l=await _.peerConfig(s.id),d=l.data?.config||l.config||"";if(!d){f.error(l.message||"获取配置失败，请检查是否已配置公网地址");return}const u=new Blob([d],{type:"text/plain"}),m=URL.createObjectURL(u),P=document.createElement("a");P.href=m,P.download=`${s.name}.conf`,P.click(),URL.revokeObjectURL(m)}catch(l){console.error(l),f.error("下载配置失败，请检查是否已配置公网地址")}},_e=async()=>{if(!n.value.endpointAddress?.trim()){f.warning("请填写公网地址，客户端需要此地址连接服务器");return}c.value=!0;try{await _.updateConfig(n.value),f.success("配置已保存"),S.value=!1,await $(),await q()}catch(s){console.error(s)}c.value=!1},ge=s=>s?`${s.slice(0,10)}...${s.slice(-6)}`:"未配置",H=async(s,l)=>{if(!s){f.warning(`${l}为空`);return}try{await navigator.clipboard.writeText(s),f.success(`${l}已复制`)}catch{f.error("复制失败")}},J=s=>{if(!s)return"0 B";const l=["B","KB","MB","GB","TB"];let d=0;for(;s>=1024&&d<l.length-1;)s/=1024,d++;return`${s.toFixed(1)} ${l[d]}`};return be(()=>{$(),G(),q(),j()}),Ve(()=>{O()}),(s,l)=>{const d=r("el-icon"),u=r("el-button"),m=r("el-tooltip"),P=r("el-card"),h=r("el-option"),I=r("el-select"),k=r("el-table-column"),X=r("el-switch"),ye=r("el-table"),F=r("el-input"),p=r("el-form-item"),Y=r("el-form"),E=r("el-dialog"),y=r("el-col"),A=r("el-row"),M=r("el-input-number"),Z=he("loading");return x(),L("div",Ne,[e(P,{class:"status-card"},{default:t(()=>[o("div",ze,[o("div",Ge,[o("div",{class:ee(["status-indicator",{online:b.value.running}])},[b.value.running?(x(),L("div",Le)):le("",!0)],2),o("div",Te,[o("span",We,v(b.value.running?"WireGuard 服务运行中":"WireGuard 服务已停止"),1),o("span",qe,v(b.value.running?"正在监听并处理连接请求":"服务已关闭，无法建立连接"),1)])]),o("div",Ee,[b.value.running?(x(),B(u,{key:1,type:"danger",onClick:ue,loading:c.value,plain:""},{default:t(()=>[e(d,null,{default:t(()=>[e(i(xe))]),_:1}),l[25]||(l[25]=w(" 停止服务 ",-1))]),_:1},8,["loading"])):(x(),B(u,{key:0,type:"success",onClick:de,loading:c.value,plain:""},{default:t(()=>[e(d,null,{default:t(()=>[e(i(ke))]),_:1}),l[24]||(l[24]=w(" 启动服务 ",-1))]),_:1},8,["loading"])),e(u,{onClick:ie,loading:c.value},{default:t(()=>[e(d,null,{default:t(()=>[e(i(Ce))]),_:1}),l[26]||(l[26]=w(" 重启 ",-1))]),_:1},8,["loading"]),e(u,{type:"primary",onClick:l[0]||(l[0]=a=>S.value=!0)},{default:t(()=>[e(d,null,{default:t(()=>[e(i(Pe))]),_:1}),l[27]||(l[27]=w(" 服务配置 ",-1))]),_:1})])]),o("div",Me,[o("div",Qe,[l[28]||(l[28]=o("span",{class:"label"},"网络接口",-1)),o("span",je,v(b.value.interface||"omniwire"),1)]),o("div",Oe,[l[29]||(l[29]=o("span",{class:"label"},"监听端口",-1)),o("span",He,v(b.value.listenPort||51820)+" UDP",1)]),o("div",Je,[l[30]||(l[30]=o("span",{class:"label"},"服务器公钥",-1)),e(m,{content:b.value.publicKey,placement:"top"},{default:t(()=>[o("span",Xe,v(ge(b.value.publicKey)),1)]),_:1},8,["content"])]),o("div",Ye,[l[31]||(l[31]=o("span",{class:"label"},"连接客户端",-1)),o("span",Ze,v(b.value.peerCount||0),1)])])]),_:1}),e(P,{class:"peers-card"},{header:t(()=>[o("div",el,[o("div",ll,[e(d,null,{default:t(()=>[e(i(se))]),_:1}),l[32]||(l[32]=o("span",null,"客户端管理",-1))]),o("div",tl,[o("div",al,[l[33]||(l[33]=o("span",null,"自动刷新: ",-1)),e(I,{modelValue:N.value,"onUpdate:modelValue":l[1]||(l[1]=a=>N.value=a),onChange:ne,size:"small",style:{width:"100px"}},{default:t(()=>[e(h,{value:0,label:"关闭"}),e(h,{value:3,label:"3秒"}),e(h,{value:5,label:"5秒"}),e(h,{value:10,label:"10秒"}),e(h,{value:30,label:"30秒"})]),_:1},8,["modelValue"])]),e(u,{type:"primary",onClick:l[2]||(l[2]=a=>U.value=!0)},{default:t(()=>[e(d,null,{default:t(()=>[e(i(Ae))]),_:1}),l[34]||(l[34]=w(" 添加客户端 ",-1))]),_:1})])])]),default:t(()=>[te((x(),B(ye,{data:Q.value,style:{width:"100%"},"row-style":{height:"60px"}},{default:t(()=>[e(k,{prop:"id",label:"ID",width:"60",align:"center"}),e(k,{prop:"name",label:"名称","min-width":"120"},{default:t(({row:a})=>[o("span",sl,v(a.name),1)]),_:1}),e(k,{label:"状态",width:"100"},{default:t(({row:a})=>[o("div",{class:ee(["peer-status",{online:a.online}])},[l[35]||(l[35]=o("span",{class:"dot"},null,-1)),w(" "+v(a.online?"在线":"离线"),1)],2)]),_:1}),e(k,{label:"IP 地址","min-width":"140"},{default:t(({row:a})=>[o("code",ol,v(a.allowedIPs),1)]),_:1}),e(k,{label:"最后握手","min-width":"140"},{default:t(({row:a})=>[o("span",nl,v(a.latestHandshake||"从未连接"),1)]),_:1}),e(k,{label:"实时流量","min-width":"160"},{default:t(({row:a})=>[o("div",dl,[o("span",ul,[e(d,null,{default:t(()=>[e(i(ae))]),_:1}),w(" "+v(J(a.transferRx)),1)]),o("span",il,[e(d,null,{default:t(()=>[e(i(Fe))]),_:1}),w(" "+v(J(a.transferTx)),1)])])]),_:1}),e(k,{label:"启用/禁用",width:"100",align:"center"},{default:t(({row:a})=>[e(X,{modelValue:a.enabled,"onUpdate:modelValue":D=>a.enabled=D,onChange:D=>ve(a),style:{"--el-switch-on-color":"var(--success)","--el-switch-off-color":"var(--text-muted)"}},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(k,{label:"操作",width:"180",fixed:"right",align:"center"},{default:t(({row:a})=>[e(m,{content:"扫码连接",placement:"top"},{default:t(()=>[e(u,{circle:"",size:"small",onClick:D=>fe(a)},{default:t(()=>[e(d,null,{default:t(()=>[e(i(Ie))]),_:1})]),_:1},8,["onClick"])]),_:2},1024),e(m,{content:"下载配置",placement:"top"},{default:t(()=>[e(u,{circle:"",size:"small",onClick:D=>me(a)},{default:t(()=>[e(d,null,{default:t(()=>[e(i(ae))]),_:1})]),_:1},8,["onClick"])]),_:2},1024),e(m,{content:"编辑",placement:"top"},{default:t(()=>[e(u,{circle:"",size:"small",onClick:D=>ce(a)},{default:t(()=>[e(d,null,{default:t(()=>[e(i(Ue))]),_:1})]),_:1},8,["onClick"])]),_:2},1024),e(m,{content:"删除",placement:"top"},{default:t(()=>[e(u,{circle:"",size:"small",type:"danger",plain:"",onClick:D=>pe(a)},{default:t(()=>[e(d,null,{default:t(()=>[e(i($e))]),_:1})]),_:1},8,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Z,R.value]])]),_:1}),e(E,{modelValue:U.value,"onUpdate:modelValue":l[6]||(l[6]=a=>U.value=a),title:C.value?"编辑客户端":"添加客户端",width:"480px","destroy-on-close":""},{footer:t(()=>[e(u,{onClick:l[5]||(l[5]=a=>U.value=!1)},{default:t(()=>[...l[37]||(l[37]=[w("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:re,loading:c.value},{default:t(()=>[w(v(C.value?"保存修改":"立即添加"),1)]),_:1},8,["loading"])]),default:t(()=>[e(Y,{model:V.value,"label-width":"80px","label-position":"top"},{default:t(()=>[e(p,{label:"名称",required:""},{default:t(()=>[e(F,{modelValue:V.value.name,"onUpdate:modelValue":l[3]||(l[3]=a=>V.value.name=a),placeholder:"例如：iPhone, Macbook Pro",size:"large"},{prefix:t(()=>[e(d,null,{default:t(()=>[e(i(se))]),_:1})]),_:1},8,["modelValue"])]),_:1}),C.value?le("",!0):(x(),B(p,{key:0,label:"IP 地址"},{default:t(()=>[e(F,{modelValue:V.value.allowedIPs,"onUpdate:modelValue":l[4]||(l[4]=a=>V.value.allowedIPs=a),placeholder:"留空自动分配",size:"large"},{prefix:t(()=>[e(d,null,{default:t(()=>[e(i(De))]),_:1})]),_:1},8,["modelValue"]),l[36]||(l[36]=o("div",{class:"form-tip"},"留空将自动从地址池分配下一个可用 IP",-1))]),_:1}))]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(E,{modelValue:S.value,"onUpdate:modelValue":l[22]||(l[22]=a=>S.value=a),title:"WireGuard 服务配置",width:"800px","custom-class":"config-dialog"},{footer:t(()=>[e(u,{onClick:l[21]||(l[21]=a=>S.value=!1)},{default:t(()=>[...l[45]||(l[45]=[w("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:_e,loading:c.value},{default:t(()=>[...l[46]||(l[46]=[w("保存配置",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(Y,{model:n.value,"label-width":"100px",size:"default"},{default:t(()=>[o("div",rl,[l[38]||(l[38]=o("div",{class:"section-header"},"密钥信息",-1)),l[39]||(l[39]=o("div",{class:"section-tip"},"密钥由系统自动生成，无需手动管理。公钥用于客户端配置，私钥请妥善保管。",-1)),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"公钥"},{default:t(()=>[o("div",cl,[o("code",pl,v(n.value.publicKey||"未生成"),1),e(u,{link:"",onClick:l[7]||(l[7]=a=>H(n.value.publicKey,"公钥"))},{default:t(()=>[e(d,null,{default:t(()=>[e(i(oe))]),_:1})]),_:1})])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"私钥"},{default:t(()=>[o("div",vl,[o("code",fl,v(K.value?n.value.privateKey||"未生成":"••••••••••••••••••••"),1),e(u,{link:"",onClick:l[8]||(l[8]=a=>K.value=!K.value)},{default:t(()=>[e(d,null,{default:t(()=>[K.value?(x(),B(i(Se),{key:1})):(x(),B(i(Be),{key:0}))]),_:1})]),_:1}),e(u,{link:"",onClick:l[9]||(l[9]=a=>H(n.value.privateKey,"私钥"))},{default:t(()=>[e(d,null,{default:t(()=>[e(i(oe))]),_:1})]),_:1})])]),_:1})]),_:1})]),_:1})]),o("div",ml,[l[42]||(l[42]=o("div",{class:"section-header"},"网络参数",-1)),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"公网地址"},{default:t(()=>[e(F,{modelValue:n.value.endpointAddress,"onUpdate:modelValue":l[10]||(l[10]=a=>n.value.endpointAddress=a),placeholder:"IP 或域名"},null,8,["modelValue"]),l[40]||(l[40]=o("div",{class:"form-tip"},"服务器公网 IP 或域名",-1))]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"VPN 网段"},{default:t(()=>[e(F,{modelValue:n.value.address,"onUpdate:modelValue":l[11]||(l[11]=a=>n.value.address=a),placeholder:"10.66.66.0/24"},null,8,["modelValue"]),l[41]||(l[41]=o("div",{class:"form-tip"},"VPN 内网地址段",-1))]),_:1})]),_:1})]),_:1}),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"监听端口"},{default:t(()=>[e(M,{modelValue:n.value.listenPort,"onUpdate:modelValue":l[12]||(l[12]=a=>n.value.listenPort=a),min:1,max:65535,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"MTU"},{default:t(()=>[e(M,{modelValue:n.value.mtu,"onUpdate:modelValue":l[13]||(l[13]=a=>n.value.mtu=a),min:1280,max:1500,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"DNS"},{default:t(()=>[e(F,{modelValue:n.value.dns,"onUpdate:modelValue":l[14]||(l[14]=a=>n.value.dns=a),placeholder:"223.5.5.5"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"客户端路由"},{default:t(()=>[e(F,{modelValue:n.value.clientAllowedIPs,"onUpdate:modelValue":l[15]||(l[15]=a=>n.value.clientAllowedIPs=a),placeholder:"自动生成"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),o("div",_l,[l[44]||(l[44]=o("div",{class:"section-header"},"高级设置",-1)),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"网卡接口"},{default:t(()=>[e(F,{modelValue:n.value.ethDevice,"onUpdate:modelValue":l[16]||(l[16]=a=>n.value.ethDevice=a),placeholder:"如 eth0（可选）"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"存活间隔"},{default:t(()=>[e(M,{modelValue:n.value.persistentKeepalive,"onUpdate:modelValue":l[17]||(l[17]=a=>n.value.persistentKeepalive=a),min:0,max:3600,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(A,{gutter:24},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(p,{label:"TCP 中转"},{default:t(()=>[e(F,{modelValue:n.value.proxyAddress,"onUpdate:modelValue":l[18]||(l[18]=a=>n.value.proxyAddress=a),placeholder:":50122 (可选)"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(p,{label:"日志等级"},{default:t(()=>[e(I,{modelValue:n.value.logLevel,"onUpdate:modelValue":l[19]||(l[19]=a=>n.value.logLevel=a),style:{width:"100%"}},{default:t(()=>[e(h,{label:"错误 (Error)",value:"error"}),e(h,{label:"警告 (Warning)",value:"warning"}),e(h,{label:"信息 (Info)",value:"info"}),e(h,{label:"调试 (Debug)",value:"debug"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(p,{label:"开机自启"},{default:t(()=>[e(X,{modelValue:n.value.autoStart,"onUpdate:modelValue":l[20]||(l[20]=a=>n.value.autoStart=a)},null,8,["modelValue"]),l[43]||(l[43]=o("span",{style:{"margin-left":"12px","font-size":"13px",color:"var(--text-muted)"}},"服务启动时自动启动 WireGuard",-1))]),_:1})])]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(E,{modelValue:T.value,"onUpdate:modelValue":l[23]||(l[23]=a=>T.value=a),title:"扫描二维码",width:"380px",center:"","destroy-on-close":""},{default:t(()=>[o("div",gl,[o("div",yl,[W.value?(x(),L("img",{key:0,src:W.value,alt:"QR Code"},null,8,wl)):te((x(),L("div",bl,null,512)),[[Z,!0]])]),l[47]||(l[47]=o("p",{class:"qr-tip"},"请使用 WireGuard 客户端扫描此二维码",-1))])]),_:1},8,["modelValue"])])}}},Pl=Ke(Vl,[["__scopeId","data-v-d4139a15"]]);export{Pl as default};
